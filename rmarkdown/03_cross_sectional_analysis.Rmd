---
title: "03_cross_sectional_analysis"
author: "Catherine Rolls"
date: "`r Sys.Date()`"
output: html_document
---


```{r setup, include=FALSE}
library(here)
source(here("scripts/00_setup.R"))

knitr::opts_chunk$set(echo = FALSE)
knitr::opts_knit$set(root.dir = here())



here()
list.files(here())

```


Load dataset: This has already had exclusions applied to it, it is a complete case dataset

```{r}
cc_dat2  <- readRDS(file.path(DATA_DERIVED, "cc_dat_described.Rds"))

IPAQ_dat2  <- readRDS(file.path(DATA_DERIVED, "IPAQ_dat_described.Rds"))

```

Data set of complete case participants for analysis
```{r}
# Select variables for cross sectional analysis
cc_dat2 <- cc_dat2 %>%
  select (
    eid,
    age_education,
    ethnicity,
    SRF,
    Wrist,
    Hip,
   num_day_mod_bin,
   num_day_vig_bin,
   num_day_walk_bin,
    date_assess_A0,
    assessment_country,
    age_A0,
    agegp_A0,
    sex,
    qualification,
    tdi,
    WC,
    weight,
    height,
    BMI,
    BMI_category,
    approx_dob_derived,
  )
```

### Univariate regression with binary PA variable and overall fracture

### MVPA isnt a true summation of mod and vig as people with missing data became NA which was about 25%

```{r}
# helper function for table
run_PA_bin_summary <- function(data, PA_bin_vars, fracture_var) {

  data <- data %>%
    mutate(across(all_of(PA_bin_vars), as.numeric))

  lapply(PA_bin_vars, function(var) {
    data %>%
      group_by(.data[[var]]) %>%
      summarise(
        N = n(),
        Fractures = sum(.data[[fracture_var]] == "Yes", na.rm = TRUE),
        `Fracture %` = round(
          100 * mean(.data[[fracture_var]] == "Yes", na.rm = TRUE), 2
        ),
        .groups = "drop"
      ) %>%
      mutate(
        PA_variable = var,
        PA_group = ifelse(.data[[var]] == 1, "Active", "Inactive")
      ) %>%
      select(PA_variable, PA_group, N, Fractures, `Fracture %`)
  }) %>%
    bind_rows()
}

PA_bin_vars <- c( "num_day_mod_bin", "num_day_vig_bin", "num_day_walk_bin")

fracture_types <- c("SRF", "Hip", "Wrist")

PA_bin_summary_all <- lapply(fracture_types, function(fx) {
  run_PA_bin_summary(cc_dat2, PA_bin_vars, fx) %>%
    mutate(Fracture_type = fx)
}) %>%
  bind_rows()

save_table_word(
  df = PA_bin_summary_all,
  table_number = "Table 3.7",
  folder_path = TABLES_DIR,
  title = "Participant counts and fracture % by binary PA group and fracture type"
)


```

```{r}
# Helper function for univariable regression

run_PA_bin_OR <- function(data, PA_bin_vars, fracture_var, confounders = NULL) {

  data <- data %>%
    mutate(
      across(all_of(PA_bin_vars), ~ factor(.x, levels = c(0, 1))),
      !!fracture_var := factor(.data[[fracture_var]], levels = c("No", "Yes"))
    )

  models <- lapply(PA_bin_vars, function(var) {

    rhs <- c(var, confounders)
    formula <- reformulate(rhs, response = fracture_var)

    glm(
      formula,
      data = data,
      family = binomial
    )
  })

  names(models) <- PA_bin_vars

  lapply(models, function(mod) {
    tidy(mod, conf.int = TRUE, exponentiate = TRUE) %>%
      filter(term %in% paste0(PA_bin_vars, "1")) %>%
      select(term, estimate, conf.low, conf.high, p.value)
  }) %>%
    bind_rows(.id = "PA_variable") %>%
    rename(
      OR = estimate,
      `95% CI lower` = conf.low,
      `95% CI upper` = conf.high,
      `p-value` = p.value
    )
}

test <- run_PA_bin_OR(
  data = cc_dat2,
  PA_bin_vars = PA_bin_vars,
  fracture_var = fracture_types[1]
)

nrow(test)
test

```

Unadjusted model 
```{r}
unadj_OR_all <- lapply(fracture_types, function(fx) {
  run_PA_bin_OR(cc_dat2, PA_bin_vars, fx) %>%
    mutate(
      Fracture_type = fx,
      Model = "Unadjusted"
    )
}) %>%
  bind_rows()

```

model 2: adjusted for age and sex
```{r}
model2_OR_all <- lapply(fracture_types, function(fx) {
  run_PA_bin_OR(
    cc_dat2,
    PA_bin_vars,
    fx,
    confounders = c("age_A0", "sex")
  ) %>%
    mutate(
      Fracture_type = fx,
      Model = "Age + sex–adjusted"
    )
}) %>%
  bind_rows()
```

model 3: adjusted for age, sex, ethnicity
```{r}
model3_OR_all <- lapply(fracture_types, function(fx) {
  run_PA_bin_OR(
    cc_dat2,
    PA_bin_vars,
    fx,
    confounders = c("age_A0", "sex", "ethnicity")
  ) %>%
    mutate(
      Fracture_type = fx,
      Model = "Age + sex + ethnicity adjusted"
    )
}) %>%
  bind_rows()
```

model 4; age,sex, ethnicity, deprivation
```{r}
model4_OR_all <- lapply(fracture_types, function(fx) {
  run_PA_bin_OR(
    cc_dat2,
    PA_bin_vars,
    fx,
    confounders = c("age_A0", "sex", "ethnicity", "tdi", "qualification")
  ) %>%
    mutate(
      Fracture_type = fx,
      Model = "Age + sex + ethnicity + deprivation adjusted"
    )
}) %>%
  bind_rows()
```
combine all results

```{r}
OR_all <- bind_rows(
  unadj_OR_all, # unadjusted
  model2_OR_all, # age and sex
  model3_OR_all, # age, sex, ethnicity
  model4_OR_all # age, sex, ethnicity, deprivation
)

```

```{r}
for (fx in fracture_types) {

  save_table_word(
    df = filter(OR_all, Fracture_type == fx),
    table_number = paste0("Table 3.9.", fx),
    folder_path = TABLES_DIR,
    title = paste("Odds ratios for PA exposures and", fx)
  )
}

```

Stratify by sex and run full models

```{r}
#Hip
# women only
women_hip <-glm(Hip ~ num_day_mod_bin + age_A0 + ethnicity + tdi + qualification, data = filter(cc_dat2, sex == "Female"), family = binomial)

# men only
men_hip <- glm(Hip ~ num_day_mod_bin + age_A0 + ethnicity + tdi + qualification, data = filter(cc_dat2, sex == "Male"), family = binomial)

#Wrist
# women only
women_wrist <- glm(Wrist ~ num_day_mod_bin + age_A0 + ethnicity + tdi + qualification, data = filter(cc_dat2, sex == "Female"), family = binomial)

# men only
men_wrist <-glm(Wrist ~ num_day_mod_bin + age_A0 + ethnicity + tdi + qualification, data = filter(cc_dat2, sex == "Male"), family = binomial)

#SRF

cc_dat2 <- cc_dat2 %>%
  mutate(
    SRF = factor(SRF, levels = c("No", "Yes"))
  )

# women only
women_SRF <- glm(SRF ~ num_day_mod_bin + age_A0 + ethnicity + tdi + qualification, data = filter(cc_dat2, sex == "Female"), family = binomial)

# men only
men_SRF <- glm(SRF ~ num_day_mod_bin + age_A0 + ethnicity + tdi + qualification, data = filter(cc_dat2, sex == "Male"), family = binomial)

# Combine into one table
bind_rows(
  tidy(women_hip, exponentiate = TRUE, conf.int = TRUE) %>% mutate(Sex = "Female"),
  tidy(men_hip, exponentiate = TRUE, conf.int = TRUE) %>% mutate(Sex = "Male"),
  tidy(women_wrist, exponentiate = TRUE, conf.int = TRUE) %>% mutate(Sex = "Female"),
  tidy(men_wrist, exponentiate = TRUE, conf.int = TRUE) %>% mutate(Sex = "Male"),
  tidy(women_SRF, exponentiate = TRUE, conf.int = TRUE) %>% mutate(Sex = "Female"),
  tidy(men_SRF, exponentiate = TRUE, conf.int = TRUE) %>% mutate(Sex = "Male")
) %>%
  select(Sex, term, estimate, conf.low, conf.high, p.value) %>%
  mutate(across(c(estimate, conf.low, conf.high, p.value), ~ round(., 3))) %>%
  rename(
    OR = estimate,
    `95% CI lower` = conf.low,
    `95% CI upper` = conf.high,
    `p-value` = p.value
  )

```

clean table of above
```{r}
PA_bin_vars <- c("num_day_mod_bin", "num_day_vig_bin", "num_day_walk_bin")
fracture_types <- c("Hip", "Wrist", "SRF")

tidy_sex_strat <- function(model, PA_vars, fracture_type, sex_label) {
  
  tidy_tbl <- broom::tidy(model, conf.int = TRUE, exponentiate = TRUE)
  
  # Filter only PA variables actually in the model
  tidy_tbl <- tidy_tbl %>%
    filter(term %in% PA_vars) %>%
    select(term, estimate, conf.low, conf.high, p.value)
  
  # Round and add labels
  tidy_tbl %>%
    mutate(
      OR = round(estimate, 3),
      `95% CI lower` = round(conf.low, 3),
      `95% CI upper` = round(conf.high, 3),
      `p-value` = round(p.value, 3),
      Fracture_type = fracture_type,
      Sex = sex_label
    ) %>%
    select(Sex, Fracture_type, term, OR, `95% CI lower`, `95% CI upper`, `p-value`)
}

# Hip
women_hip <- glm(Hip ~ num_day_mod_bin + num_day_vig_bin + num_day_walk_bin + 
                 age_A0 + ethnicity + tdi + qualification, 
                 data = filter(cc_dat2, sex == "Female"), family = binomial)

men_hip <- glm(Hip ~ num_day_mod_bin + num_day_vig_bin + num_day_walk_bin + 
               age_A0 + ethnicity + tdi + qualification, 
               data = filter(cc_dat2, sex == "Male"), family = binomial)

# Wrist
women_wrist <- glm(Wrist ~ num_day_mod_bin + num_day_vig_bin + num_day_walk_bin + 
                   age_A0 + ethnicity + tdi + qualification, 
                   data = filter(cc_dat2, sex == "Female"), family = binomial)

men_wrist <- glm(Wrist ~ num_day_mod_bin + num_day_vig_bin + num_day_walk_bin + 
                 age_A0 + ethnicity + tdi + qualification, 
                 data = filter(cc_dat2, sex == "Male"), family = binomial)

# SRF
cc_dat2 <- cc_dat2 %>%
  mutate(SRF = factor(SRF, levels = c("No", "Yes")))

women_SRF <- glm(SRF ~ num_day_mod_bin + num_day_vig_bin + num_day_walk_bin + 
                 age_A0 + ethnicity + tdi + qualification, 
                 data = filter(cc_dat2, sex == "Female"), family = binomial)

men_SRF <- glm(SRF ~ num_day_mod_bin + num_day_vig_bin + num_day_walk_bin + 
               age_A0 + ethnicity + tdi + qualification, 
               data = filter(cc_dat2, sex == "Male"), family = binomial)

women_hip_tbl  <- tidy_sex_strat(women_hip, PA_bin_vars, "Hip", "Female")
men_hip_tbl    <- tidy_sex_strat(men_hip, PA_bin_vars, "Hip", "Male")

women_wrist_tbl <- tidy_sex_strat(women_wrist, PA_bin_vars, "Wrist", "Female")
men_wrist_tbl   <- tidy_sex_strat(men_wrist, PA_bin_vars, "Wrist", "Male")

women_SRF_tbl  <- tidy_sex_strat(women_SRF, PA_bin_vars, "SRF", "Female")
men_SRF_tbl    <- tidy_sex_strat(men_SRF, PA_bin_vars, "SRF", "Male")

OR_sex_strat <- bind_rows(
  women_hip_tbl, men_hip_tbl,
  women_wrist_tbl, men_wrist_tbl,
  women_SRF_tbl, men_SRF_tbl
)

OR_sex_strat <- OR_sex_strat %>%
  mutate(PA_exposure = recode(term,
                              num_day_mod_bin = "Does 1 or more days mod PA",
                              num_day_vig_bin = "Does 1 or more days vig PA",
                              num_day_walk_bin = "Walks on one or more days")) %>%
  select(Sex, Fracture_type, PA_exposure, OR, `95% CI lower`, `95% CI upper`, `p-value`) %>%
  arrange(Fracture_type, Sex, PA_exposure)

View(OR_sex_strat)  # Opens in RStudio
OR_sex_strat        # Prints to console

save_table_word(
  df = OR_sex_strat,  # the full table with all fractures and sexes
  table_number = "Table 3.11",
  folder_path = TABLES_DIR,
  title = "Odds ratios for PA exposures by sex and fracture type"
)

```
Sensitivity analysis and assumptions


#### To get a clearer idea of dose reponse we will use the data filetered on having complete IPAQ data in order to use dose responses

```{r}
# Select variables for cross sectional dose response analysis
IPAQ_dat2 <- IPAQ_dat2 %>%
  select (
    eid,
    age_education,
    ethnicity,
    SRF,
    Wrist,
    Hip,
    IPAQ,
    MET_mod,
    MET_vig,
    MET_MVPA,
    MET_walk,
    log_MET_mod, 
    log_MET_vig,
    log_MET_MVPA,
   log_MET_walk,
   MET_mod_bin,
   MET_vig_bin,
   MET_MVPA_bin,
   num_day_mod_bin,
   num_day_vig_bin,
   num_day_walk_bin,
    date_assess_A0,
    assessment_country,
    age_A0,
    agegp_A0,
    sex,
    qualification,
    tdi,
    WC,
    weight,
    height,
    BMI,
    BMI_category,
    approx_dob_derived,
  )
```

### Univariate regression with binary PA variable and overall fracture

### MVPA isnt a true summation of mod and vig as people with missing data became NA which was about 25%

```{r}
# helper function for table
run_PA_bin_summary <- function(data, PA_bin_vars, fracture_var) {

  data <- data %>%
    mutate(across(all_of(PA_bin_vars), as.numeric))

  lapply(PA_bin_vars, function(var) {
    data %>%
      group_by(.data[[var]]) %>%
      summarise(
        N = n(),
        Fractures = sum(.data[[fracture_var]] == "Yes", na.rm = TRUE),
        `Fracture %` = round(
          100 * mean(.data[[fracture_var]] == "Yes", na.rm = TRUE), 2
        ),
        .groups = "drop"
      ) %>%
      mutate(
        PA_variable = var,
        PA_group = ifelse(.data[[var]] == 1, "Active", "Inactive")
      ) %>%
      select(PA_variable, PA_group, N, Fractures, `Fracture %`)
  }) %>%
    bind_rows()
}

PA_bin_vars <- c("MET_mod_bin", "MET_vig_bin", "MET_MVPA_bin", "num_day_mod_bin", "num_day_vig_bin", "num_day_walk_bin")

fracture_types <- c("SRF", "Hip", "Wrist")

PA_bin_summary_all <- lapply(fracture_types, function(fx) {
  run_PA_bin_summary(cc_dat, PA_bin_vars, fx) %>%
    mutate(Fracture_type = fx)
}) %>%
  bind_rows()

save_table_word(
  df = PA_bin_summary_all,
  table_number = "Table 3.6",
  folder_path = TABLES_DIR,
  title = "Participant counts and fracture % by binary PA group and fracture type"
)


```

```{r}
# Helper function for univariable regression

run_PA_bin_univariable_OR <- function(data, PA_bin_vars, fracture_var) {

  data <- data %>%
    mutate(
      across(all_of(PA_bin_vars), ~ factor(.x, levels = c(0, 1))),
      !!fracture_var := factor(.data[[fracture_var]], levels = c("No", "Yes"))
    )

  models <- lapply(PA_bin_vars, function(var) {
    glm(
      reformulate(var, response = fracture_var),
      data = data,
      family = binomial
    )
  })
  names(models) <- PA_bin_vars

  lapply(models, function(mod) {
    tidy(mod, conf.int = TRUE, exponentiate = TRUE) %>%
      filter(term != "(Intercept)") %>%
      select(term, estimate, conf.low, conf.high, p.value) %>%
      mutate(PA_group = "Active")
  }) %>%
    bind_rows(.id = "PA_variable") %>%
    rename(
      OR = estimate,
      `95% CI lower` = conf.low,
      `95% CI upper` = conf.high,
      `p-value` = p.value
    )
}

univariable_OR_all <- lapply(fracture_types, function(fx) {
  run_PA_bin_univariable_OR(cc_dat, PA_bin_vars, fx) %>%
    mutate(Fracture_type = fx)
}) %>%
  bind_rows()
```

```{r}
for (fx in fracture_types) {

  save_table_word(
    df = filter(univariable_OR_all, Fracture_type == fx),
    table_number = paste0("Table 3.", fx),
    folder_path = TABLES_DIR,
    title = paste("Univariable ORs for PA exposures and", fx)
  )
}
```

##### Log transformed and convert to z-score to standardise

```{r}
PA_vars <- c("MET_mod", "MET_vig", "MET_walk", "MET_MVPA", "summed_MET_all")

for (var in PA_vars) {
  z_var <- paste0("z_", var)
  cc_dat[[z_var]] <- (cc_dat[[var]] - mean(cc_dat[[var]], na.rm = TRUE)) / 
                      sd(cc_dat[[var]], na.rm = TRUE)
}
z_PA_vars <- paste0("z_", PA_vars)


models_z <- list()
for (var in z_PA_vars) {
  fmla <- reformulate(var, response = "SRF")  # SRF ~ z_MET_mod etc.
  models_z[[var]] <- glm(fmla, data = cc_dat, family = binomial)
}

univariable_OR_table_z <- lapply(models_z, function(mod) {
  tidy(mod, conf.int = TRUE, exponentiate = TRUE) %>% 
    filter(term != "(Intercept)") %>% 
    select(term, estimate, conf.low, conf.high, p.value)
}) %>%
  bind_rows(.id = "Variable") %>%
  rename(
    OR = estimate,
    `95% CI lower` = conf.low,
    `95% CI upper` = conf.high,
    `p-value` = p.value
  )

univariable_OR_table_z

save_table_word(
  df = univariable_OR_table_z,
  table_number = "Table 3.4",
  folder_path = TABLES_DIR,
  title = "Univariable OR table (per 1 SD increase in log PA)"
)

```

# Wrist fracture
```{r}
PA_vars <- c("MET_mod", "MET_vig", "MET_walk", "MET_MVPA", "summed_MET_all")

for (var in PA_vars) {
  z_var <- paste0("z_", var)
  cc_dat[[z_var]] <- (cc_dat[[var]] - mean(cc_dat[[var]], na.rm = TRUE)) / 
                      sd(cc_dat[[var]], na.rm = TRUE)
}
z_PA_vars <- paste0("z_", PA_vars)


models_z <- list()
for (var in z_PA_vars) {
  fmla <- reformulate(var, response = "Wrist")  # Wrist ~ z_MET_mod etc.
  models_z[[var]] <- glm(fmla, data = cc_dat, family = binomial)
}

univariable_OR_table_z <- lapply(models_z, function(mod) {
  tidy(mod, conf.int = TRUE, exponentiate = TRUE) %>% 
    filter(term != "(Intercept)") %>% 
    select(term, estimate, conf.low, conf.high, p.value)
}) %>%
  bind_rows(.id = "Variable") %>%
  rename(
    OR = estimate,
    `95% CI lower` = conf.low,
    `95% CI upper` = conf.high,
    `p-value` = p.value
  )

univariable_OR_table_z

save_table_word(
  df = univariable_OR_table_z,
  table_number = "Table 3.5",
  folder_path = TABLES_DIR,
  title = "Wrist fracture Univariable OR table (per 1 SD increase in log PA)"
)

```

Hip fracture

```{r}
PA_vars <- c("MET_mod", "MET_vig", "MET_walk", "MET_MVPA", "summed_MET_all")

for (var in PA_vars) {
  z_var <- paste0("z_", var)
  cc_dat[[z_var]] <- (cc_dat[[var]] - mean(cc_dat[[var]], na.rm = TRUE)) / 
                      sd(cc_dat[[var]], na.rm = TRUE)
}
z_PA_vars <- paste0("z_", PA_vars)


models_z <- list()
for (var in z_PA_vars) {
  fmla <- reformulate(var, response = "Hip")  # Hip ~ z_MET_mod etc.
  models_z[[var]] <- glm(fmla, data = cc_dat, family = binomial)
}

univariable_OR_table_z <- lapply(models_z, function(mod) {
  tidy(mod, conf.int = TRUE, exponentiate = TRUE) %>% 
    filter(term != "(Intercept)") %>% 
    select(term, estimate, conf.low, conf.high, p.value)
}) %>%
  bind_rows(.id = "Variable") %>%
  rename(
    OR = estimate,
    `95% CI lower` = conf.low,
    `95% CI upper` = conf.high,
    `p-value` = p.value
  )

univariable_OR_table_z

save_table_word(
  df = univariable_OR_table_z,
  table_number = "Table 3.6",
  folder_path = TABLES_DIR,
  title = "Hip fracture Univariable OR table (per 1 SD increase in log PA)"
)

```




#### Scale to 30 min per week increments for interpretation

```{r}
# Scale by 30 minutes
dat <- dat %>%
  mutate(
    MET_mod_30min = MET_mod / 30,
    MET_vig_30min = MET_vig / 30,
    MET_walk_30min = MET_walk / 30,
    MET_MVPA_30min = MET_MVPA / 30
  )

PA_vars_scaled <- c("MET_mod_30min", "MET_vig_30min", "MET_walk_30min", "MET_MVPA_30min")

models <- list()

for (var in PA_vars_scaled) {
  fmla <- reformulate(var, response = "SRF")  # creates SRF ~ var
  models[[var]] <- glm(fmla, data = dat, family = binomial)
}


OR_table <- lapply(models, function(mod) {
  tidy(mod, conf.int = TRUE, exponentiate = TRUE) %>%  # exponentiate = TRUE gives OR
    filter(term != "(Intercept)") %>%                   # keep only the PA variable
    select(term, estimate, conf.low, conf.high, p.value)
}) %>%
  bind_rows(.id = "Variable") %>%
  rename(
    OR = estimate,
    `95% CI lower` = conf.low,
    `95% CI upper` = conf.high,
    `p-value` = p.value
  )

OR_table

```
### Check linearity assumption

#### 30 min increase in mod PA
```{r}
# Fit the model
mod <- glm(SRF ~ MET_mod_30min, data = dat, family = binomial)

# Calculate logit (linear predictor)
dat$logit <- predict(mod, type = "link")  # type="link" gives logit

# Scatter plot of predictor vs logit
library(ggplot2)

ggplot(dat, aes(x = MET_mod_30min, y = logit)) +
  geom_point(alpha = 0.1) +
  geom_smooth(method = "loess", se = FALSE) +
  labs(x = "Moderate PA (30 min units)", y = "Logit(SRF = Yes)",
       title = "Check linearity of MET_mod in logistic regression")
```

#### 30 min increase in vig PA
```{r}
# Fit the model
mod <- glm(SRF ~ MET_vig_30min, data = dat, family = binomial)

# Calculate logit (linear predictor)
dat$logit <- predict(mod, type = "link")  # type="link" gives logit

# Scatter plot of predictor vs logit
library(ggplot2)

ggplot(dat, aes(x = MET_vig_30min, y = logit)) +
  geom_point(alpha = 0.1) +
  geom_smooth(method = "loess", se = FALSE) +
  labs(x = "Moderate PA (30 min units)", y = "Logit(SRF = Yes)",
       title = "Check linearity of MET_vig in logistic regression")
```
### Look at relationship between PA and fracture in the middle 80% of participants - ie ruling out the extremes. Does this shift to a protective effect

```{r}
# set a group of 80% activity particpants
PA_vars <- c("MET_mod", "MET_vig", "MET_walk", "MET_MVPA")

dat_middle80 <- dat

for (var in PA_vars) {
  lower <- quantile(dat[[var]], 0.10, na.rm = TRUE)
  upper <- quantile(dat[[var]], 0.90, na.rm = TRUE)
  
  dat_middle80 <- dat_middle80 %>%
    filter(.data[[var]] >= lower & .data[[var]] <= upper)
}

dat_middle80 <- dat_middle80 %>%
  mutate(
    MET_mod_30min  = MET_mod / 30,
    MET_vig_30min  = MET_vig / 30,
    MET_walk_30min = MET_walk / 30,
    MET_MVPA_30min = MET_MVPA / 30
  )
```

```{r}

# Function to fit model and return tidy OR table


get_OR <- function(var) {
  formula <- as.formula(paste("SRF ~", var))
  mod <- glm(formula, data = dat_middle80, family = binomial)
  
  broom::tidy(mod, exponentiate = TRUE, conf.int = TRUE) %>%
    filter(term != "(Intercept)") %>%
    select(term, estimate, conf.low, conf.high, p.value)
}

# Apply to all four PA variables
OR_list <- lapply(c("MET_mod_30min", "MET_vig_30min", "MET_walk_30min", "MET_MVPA_30min"), get_OR)
OR_table <- bind_rows(OR_list)

# Optional: clean column names
OR_table <- OR_table %>%
  rename(
    PA_variable = term,
    OR = estimate,
    `95% CI lower` = conf.low,
    `95% CI upper` = conf.high,
    `p-value` = p.value
  )

OR_table

```
#### With age and sex as interactions

```{r}
mod <- glm(
  SRF ~ MET_mod_30min * agegp_A0 * sex,
  data = dat_middle80,
  family = binomial
)

emm <- emmeans(
  mod,
  ~ MET_mod_30min | agegp_A0 * sex,
  at = list(MET_mod_30min = c(0, 1))  # per 30 min
)


OR_emm <- contrast(
  emm,
  method = "revpairwise"
) %>%
  summary(infer = TRUE, exp = TRUE)

OR_table_emm <- OR_emm %>%
  as.data.frame() %>%
  transmute(
    Age_group = agegp_A0,
    Sex = sex,
    OR = round(estimate, 3),
    `95% CI lower` = round(asymp.LCL, 3),
    `95% CI upper` = round(asymp.UCL, 3),
    `p-value` = format.pval(p.value, digits = 3, eps = 0.001),
    `OR (95% CI)` = paste0(
      OR, " (", `95% CI lower`, "–", `95% CI upper`, ")"
    )
  ) %>%
  select(Age_group, Sex, `OR (95% CI)`, `p-value`)


Table_3.7 <- make_table(
  OR_table_emm,
  table_number = "3.7",
  folder_path = Table_folder_path,
  title = "Age- and sex-specific odds ratios for fracture per 30-minute increase in moderate physical activity"
)

Table_3.7

```


```{r}

# Function to fit model and return tidy OR table


get_OR <- function(var) {
  
  formula <- as.formula(paste("SRF ~", var, "+ agegp_A0 + sex"))
  
  mod <- glm(formula, data = dat_middle80, family = binomial)
  
  broom::tidy(mod, exponentiate = TRUE, conf.int = TRUE) %>%
    filter(term == var) %>%              # keep only PA effect
    transmute(
      PA_variable = var,
      OR = estimate,
      `95% CI lower` = conf.low,
      `95% CI upper` = conf.high,
      `p-value` = p.value
    )
}
PA_vars <- c("MET_mod_30min", "MET_vig_30min", 
             "MET_walk_30min", "MET_MVPA_30min")

OR_table <- bind_rows(lapply(PA_vars, get_OR))

OR_table_for_make <- OR_table %>%
  mutate(
    OR = round(OR, 3),
    `95% CI lower` = round(`95% CI lower`, 3),
    `95% CI upper` = round(`95% CI upper`, 3),
    `p-value` = format.pval(`p-value`, digits = 3, eps = 0.001),
    `OR (95% CI)` = paste0(
      OR, " (", `95% CI lower`, "–", `95% CI upper`, ")"
    ),
    PA_variable = case_when(
      PA_variable == "MET_mod_30min"  ~ "Moderate PA (per 30 min/week)",
      PA_variable == "MET_vig_30min"  ~ "Vigorous PA (per 30 min/week)",
      PA_variable == "MET_walk_30min" ~ "Walking (per 30 min/week)",
      PA_variable == "MET_MVPA_30min" ~ "MVPA (per 30 min/week)"
    )
  ) %>%
  select(PA_variable, `OR (95% CI)`, `p-value`)

Table_3.6 <- make_table(
  OR_table_for_make,
  table_number = "3.6",
  folder_path = Table_folder_path,
  title = "Odds ratios for fracture associated with physical activity (middle 80% of PA)"
)

Table_3.6


```

#### By different fracture site

#### Hip
```{r}
# Function to fit model and return tidy OR table
get_OR <- function(var) {
  formula <- as.formula(paste("Hip ~", var))
  mod <- glm(formula, data = dat_middle80, family = binomial)
  
  broom::tidy(mod, exponentiate = TRUE, conf.int = TRUE) %>%
    filter(term != "(Intercept)") %>%
    select(term, estimate, conf.low, conf.high, p.value)
}

# Apply to all four PA variables
OR_list <- lapply(c("MET_mod_30min", "MET_vig_30min", "MET_walk_30min", "MET_MVPA_30min"), get_OR)
OR_table <- bind_rows(OR_list)

# Optional: clean column names
OR_table <- OR_table %>%
  rename(
    PA_variable = term,
    OR = estimate,
    `95% CI lower` = conf.low,
    `95% CI upper` = conf.high,
    `p-value` = p.value
  )

OR_table

```
#### wrist
```{r}
# Function to fit model and return tidy OR table
get_OR <- function(var) {
  formula <- as.formula(paste("Wrist ~", var))
  mod <- glm(formula, data = dat_middle80, family = binomial)
  
  broom::tidy(mod, exponentiate = TRUE, conf.int = TRUE) %>%
    filter(term != "(Intercept)") %>%
    select(term, estimate, conf.low, conf.high, p.value)
}

# Apply to all four PA variables
OR_list <- lapply(c("MET_mod_30min", "MET_vig_30min", "MET_walk_30min", "MET_MVPA_30min"), get_OR)
OR_table <- bind_rows(OR_list)

# Optional: clean column names
OR_table <- OR_table %>%
  rename(
    PA_variable = term,
    OR = estimate,
    `95% CI lower` = conf.low,
    `95% CI upper` = conf.high,
    `p-value` = p.value
  )

OR_table

```

### Looking at whether individuals are achieving WHO guidelines

#### Looking at 4 variables
- Meets WHO MVPA guidelines (Y/N) (150-300mins MVPA)
- Above WHO MVPA guidelines (Y/N) (over 300 mins MVPA)
- Meets WHO Vig guidelines (Y/N) (75-150 mins vig)
- Above WHO Vig guidelines (Y/N) (over 150 mins vig)

```{r}
dat <- dat %>%
  mutate(
    # Meets WHO MVPA (150–300 min/week)
    Meets_WHO_MVPA = if_else(mins_wk_MVPA >= 150 & mins_wk_MVPA <= 300, 1, 0),
    
    # Above WHO MVPA (>300 min/week)
    Above_WHO_MVPA = if_else(mins_wk_MVPA > 300, 1, 0)
  )

dat <- dat %>%
  mutate(
    # Meets WHO Vigorous (75–150 min/week)
    Meets_WHO_Vig = if_else(mins_wk_vig >= 75 & mins_wk_vig <= 150, 1, 0),
    
    # Above WHO Vigorous (>150 min/week)
    Above_WHO_Vig = if_else(mins_wk_vig > 150, 1, 0)
  )


table(dat$Meets_WHO_MVPA)
table(dat$Above_WHO_MVPA)
table(dat$Meets_WHO_Vig)
table(dat$Above_WHO_Vig)
```
#### Regression
```{r}

# Function to run a binary logistic regression and extract OR and CI
get_OR_binary <- function(var, data, outcome = "SRF") {
  formula <- as.formula(paste(outcome, "~", var))
  
  glm_model <- glm(formula, data = data, family = binomial)
  
  broom::tidy(glm_model, exponentiate = TRUE, conf.int = TRUE) %>%
    filter(term != "(Intercept)") %>%
    select(term, estimate, conf.low, conf.high, p.value) %>%
    rename(
      Variable = term,
      OR = estimate,
      `95% CI lower` = conf.low,
      `95% CI upper` = conf.high,
      `p-value` = p.value
    ) %>%
    mutate(Exposure = var)
}

WHO_vars <- c("Meets_WHO_MVPA", "Above_WHO_MVPA", "Meets_WHO_Vig", "Above_WHO_Vig")

OR_list <- lapply(WHO_vars, get_OR_binary, data = dat)
OR_table <- bind_rows(OR_list)

# Optional: clean exposure names for readability
OR_table <- OR_table %>%
  mutate(
    Exposure = case_when(
      Exposure == "Meets_WHO_MVPA" ~ "Meets WHO MVPA (150–300 min/week)",
      Exposure == "Above_WHO_MVPA" ~ "Above WHO MVPA (>300 min/week)",
      Exposure == "Meets_WHO_Vig"  ~ "Meets WHO Vig (75–150 min/week)",
      Exposure == "Above_WHO_Vig"  ~ "Above WHO Vig (>150 min/week)"
    ))

OR_table

```
#### Hip
```{r}

# Function to run a binary logistic regression and extract OR and CI
get_OR_binary <- function(var, data, outcome = "Hip") {
  formula <- as.formula(paste(outcome, "~", var))
  
  glm_model <- glm(formula, data = data, family = binomial)
  
  broom::tidy(glm_model, exponentiate = TRUE, conf.int = TRUE) %>%
    filter(term != "(Intercept)") %>%
    select(term, estimate, conf.low, conf.high, p.value) %>%
    rename(
      Variable = term,
      OR = estimate,
      `95% CI lower` = conf.low,
      `95% CI upper` = conf.high,
      `p-value` = p.value
    ) %>%
    mutate(Exposure = var)
}

WHO_vars <- c("Meets_WHO_MVPA", "Above_WHO_MVPA", "Meets_WHO_Vig", "Above_WHO_Vig")

OR_list <- lapply(WHO_vars, get_OR_binary, data = dat)
OR_table <- bind_rows(OR_list)

# Optional: clean exposure names for readability
OR_table <- OR_table %>%
  mutate(
    Exposure = case_when(
      Exposure == "Meets_WHO_MVPA" ~ "Meets WHO MVPA (150–300 min/week)",
      Exposure == "Above_WHO_MVPA" ~ "Above WHO MVPA (>300 min/week)",
      Exposure == "Meets_WHO_Vig"  ~ "Meets WHO Vig (75–150 min/week)",
      Exposure == "Above_WHO_Vig"  ~ "Above WHO Vig (>150 min/week)"
    ))

OR_table

```

#### Wrist

```{r}

# Function to run a binary logistic regression and extract OR and CI
get_OR_binary <- function(var, data, outcome = "Wrist") {
  formula <- as.formula(paste(outcome, "~", var))
  
  glm_model <- glm(formula, data = data, family = binomial)
  
  broom::tidy(glm_model, exponentiate = TRUE, conf.int = TRUE) %>%
    filter(term != "(Intercept)") %>%
    select(term, estimate, conf.low, conf.high, p.value) %>%
    rename(
      Variable = term,
      OR = estimate,
      `95% CI lower` = conf.low,
      `95% CI upper` = conf.high,
      `p-value` = p.value
    ) %>%
    mutate(Exposure = var)
}

WHO_vars <- c("Meets_WHO_MVPA", "Above_WHO_MVPA", "Meets_WHO_Vig", "Above_WHO_Vig")

OR_list <- lapply(WHO_vars, get_OR_binary, data = dat)
OR_table <- bind_rows(OR_list)

# Optional: clean exposure names for readability
OR_table <- OR_table %>%
  mutate(
    Exposure = case_when(
      Exposure == "Meets_WHO_MVPA" ~ "Meets WHO MVPA (150–300 min/week)",
      Exposure == "Above_WHO_MVPA" ~ "Above WHO MVPA (>300 min/week)",
      Exposure == "Meets_WHO_Vig"  ~ "Meets WHO Vig (75–150 min/week)",
      Exposure == "Above_WHO_Vig"  ~ "Above WHO Vig (>150 min/week)"
    ))

OR_table

```

#### All fracture in sex stratified analysis

```{r}
# Split dataset
dat_female <- dat %>% filter(sex == "Female")
dat_male   <- dat %>% filter(sex == "Male")

WHO_vars <- c("Meets_WHO_MVPA", "Above_WHO_MVPA", "Meets_WHO_Vig", "Above_WHO_Vig")

get_OR_binary <- function(var, data, outcome = "SRF") {
  formula <- as.formula(paste(outcome, "~", var))
  
  glm_model <- glm(formula, data = data, family = binomial)
  
  broom::tidy(glm_model, exponentiate = TRUE, conf.int = TRUE) %>%
    filter(term != "(Intercept)") %>%
    select(term, estimate, conf.low, conf.high, p.value) %>%
    rename(
      Variable = term,
      OR = estimate,
      `95% CI lower` = conf.low,
      `95% CI upper` = conf.high,
      `p-value` = p.value
    ) %>%
    mutate(Exposure = var)
}

OR_list_female <- lapply(WHO_vars, get_OR_binary, data = dat_female)
OR_table_female <- bind_rows(OR_list_female) %>%
  mutate(
    Exposure = case_when(
      Exposure == "Meets_WHO_MVPA" ~ "Meets WHO MVPA (150–300 min/week)",
      Exposure == "Above_WHO_MVPA" ~ "Above WHO MVPA (>300 min/week)",
      Exposure == "Meets_WHO_Vig"  ~ "Meets WHO Vig (75–150 min/week)",
      Exposure == "Above_WHO_Vig"  ~ "Above WHO Vig (>150 min/week)"
    ),
    Sex = "Female"
  )

OR_list_male <- lapply(WHO_vars, get_OR_binary, data = dat_male)
OR_table_male <- bind_rows(OR_list_male) %>%
  mutate(
    Exposure = case_when(
      Exposure == "Meets_WHO_MVPA" ~ "Meets WHO MVPA (150–300 min/week)",
      Exposure == "Above_WHO_MVPA" ~ "Above WHO MVPA (>300 min/week)",
      Exposure == "Meets_WHO_Vig"  ~ "Meets WHO Vig (75–150 min/week)",
      Exposure == "Above_WHO_Vig"  ~ "Above WHO Vig (>150 min/week)"
    ),
    Sex = "Male"
  )

OR_table_sex <- bind_rows(OR_table_female, OR_table_male) %>%
  select(Sex, Exposure, OR, `95% CI lower`, `95% CI upper`, `p-value`)

OR_table_sex
```

#### Hip fracture in sex stratified analysis

```{r}
# Split dataset
dat_female <- dat %>% filter(sex == "Female")
dat_male   <- dat %>% filter(sex == "Male")

WHO_vars <- c("Meets_WHO_MVPA", "Above_WHO_MVPA", "Meets_WHO_Vig", "Above_WHO_Vig")

get_OR_binary <- function(var, data, outcome = "Hip") {
  formula <- as.formula(paste(outcome, "~", var))
  
  glm_model <- glm(formula, data = data, family = binomial)
  
  broom::tidy(glm_model, exponentiate = TRUE, conf.int = TRUE) %>%
    filter(term != "(Intercept)") %>%
    select(term, estimate, conf.low, conf.high, p.value) %>%
    rename(
      Variable = term,
      OR = estimate,
      `95% CI lower` = conf.low,
      `95% CI upper` = conf.high,
      `p-value` = p.value
    ) %>%
    mutate(Exposure = var)
}

OR_list_female <- lapply(WHO_vars, get_OR_binary, data = dat_female)
OR_table_female <- bind_rows(OR_list_female) %>%
  mutate(
    Exposure = case_when(
      Exposure == "Meets_WHO_MVPA" ~ "Meets WHO MVPA (150–300 min/week)",
      Exposure == "Above_WHO_MVPA" ~ "Above WHO MVPA (>300 min/week)",
      Exposure == "Meets_WHO_Vig"  ~ "Meets WHO Vig (75–150 min/week)",
      Exposure == "Above_WHO_Vig"  ~ "Above WHO Vig (>150 min/week)"
    ),
    Sex = "Female"
  )

OR_list_male <- lapply(WHO_vars, get_OR_binary, data = dat_male)
OR_table_male <- bind_rows(OR_list_male) %>%
  mutate(
    Exposure = case_when(
      Exposure == "Meets_WHO_MVPA" ~ "Meets WHO MVPA (150–300 min/week)",
      Exposure == "Above_WHO_MVPA" ~ "Above WHO MVPA (>300 min/week)",
      Exposure == "Meets_WHO_Vig"  ~ "Meets WHO Vig (75–150 min/week)",
      Exposure == "Above_WHO_Vig"  ~ "Above WHO Vig (>150 min/week)"
    ),
    Sex = "Male"
  )

OR_table_sex <- bind_rows(OR_table_female, OR_table_male) %>%
  select(Sex, Exposure, OR, `95% CI lower`, `95% CI upper`, `p-value`)

OR_table_sex
```

#### Wrist fracture in sex stratified analysis

```{r}
# Split dataset
dat_female <- dat %>% filter(sex == "Female")
dat_male   <- dat %>% filter(sex == "Male")

WHO_vars <- c("Meets_WHO_MVPA", "Above_WHO_MVPA", "Meets_WHO_Vig", "Above_WHO_Vig")

get_OR_binary <- function(var, data, outcome = "Wrist") {
  formula <- as.formula(paste(outcome, "~", var))
  
  glm_model <- glm(formula, data = data, family = binomial)
  
  broom::tidy(glm_model, exponentiate = TRUE, conf.int = TRUE) %>%
    filter(term != "(Intercept)") %>%
    select(term, estimate, conf.low, conf.high, p.value) %>%
    rename(
      Variable = term,
      OR = estimate,
      `95% CI lower` = conf.low,
      `95% CI upper` = conf.high,
      `p-value` = p.value
    ) %>%
    mutate(Exposure = var)
}

OR_list_female <- lapply(WHO_vars, get_OR_binary, data = dat_female)
OR_table_female <- bind_rows(OR_list_female) %>%
  mutate(
    Exposure = case_when(
      Exposure == "Meets_WHO_MVPA" ~ "Meets WHO MVPA (150–300 min/week)",
      Exposure == "Above_WHO_MVPA" ~ "Above WHO MVPA (>300 min/week)",
      Exposure == "Meets_WHO_Vig"  ~ "Meets WHO Vig (75–150 min/week)",
      Exposure == "Above_WHO_Vig"  ~ "Above WHO Vig (>150 min/week)"
    ),
    Sex = "Female"
  )

OR_list_male <- lapply(WHO_vars, get_OR_binary, data = dat_male)
OR_table_male <- bind_rows(OR_list_male) %>%
  mutate(
    Exposure = case_when(
      Exposure == "Meets_WHO_MVPA" ~ "Meets WHO MVPA (150–300 min/week)",
      Exposure == "Above_WHO_MVPA" ~ "Above WHO MVPA (>300 min/week)",
      Exposure == "Meets_WHO_Vig"  ~ "Meets WHO Vig (75–150 min/week)",
      Exposure == "Above_WHO_Vig"  ~ "Above WHO Vig (>150 min/week)"
    ),
    Sex = "Male"
  )

OR_table_sex <- bind_rows(OR_table_female, OR_table_male) %>%
  select(Sex, Exposure, OR, `95% CI lower`, `95% CI upper`, `p-value`)

OR_table_sex
```
