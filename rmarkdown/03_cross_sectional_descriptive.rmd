---
title: "Cross Sectional data descriptive"
author: "Catherine Rolls"
date: '`r Sys.Date()`'
output: html_document
---

```{r setup, include=FALSE}
library(here)
source(here("scripts/00_setup.R"))

knitr::opts_chunk$set(echo = FALSE)
knitr::opts_knit$set(root.dir = here())



here()
list.files(here())

```

Load dataset: This has already had exclusions applied to it, it is a complete case dataset

```{r}
cc_dat  <- readRDS(file.path(DATA_DERIVED, "complete_case_dat.Rds"))

```

Data set of complete case participants for analysis
```{r}
# Select variables for cross sectional analysis
cc_dat <- cc_dat %>%
  select (
    eid,
    age_education,
    ethnicity,
    SRF,
    Wrist,
    Hip,
    duration_mod_PA,
    num_days_mod_PA,
    duration_vig_PA,
    num_days_vig_PA,
    duration_walk,
    num_day_walk,
    IPAQ,
    MET_mod = cc_MET_mod, 
    mins_wk_mod = cc_mins_wk_mod,
    MET_vig = cc_MET_vig,
   mins_wk_vig =  cc_mins_wk_vig,
   MET_MVPA = cc_MET_MVPA,
   mins_wk_MVPA = cc_mins_wk_MVPA,
    MET_walk = cc_MET_walk,
    mins_wk_walk = cc_mins_wk_walk,
    MET_summed = cc_MET_summed,
    mins_wk_summed = cc_mins_wk_summed,
    MET_mod_derived = MET_mod,
    MET_vig_derived = MET_vig,
    MET_walk_derived = MET_walk,
    MVPA_derived = MVPA,
    summed_MET_all = cc_MET_summed,
   mins_wk_summed = cc_mins_wk_summed,
    date_assess_A0,
    assessment_country,
    age_A0,
    agegp_A0,
    sex,
    qualification,
    tdi,
    WC,
    weight,
    height,
    BMI,
    BMI_category,
    lost_to_fu,
    approx_dob_derived,
  )
```


Create Table 1 (Demographics)
```{r}
library(table1)

# Create table1 object
table1 <- table1(
  ~ age_A0 + ethnicity + tdi + qualification + weight + height + WC + BMI + SRF + Wrist + Hip + IPAQ | sex, 
  data = cc_dat,
  overall = "Total"
)


# Build the PNG file in FIGURES_DIR
png(
  filename = file.path(FIGURES_DIR, "Figure_2_Table1.png"),
  width = 1200,
  height = 800,
  res = 150
)

# Render the table as a figure
gridExtra::grid.table(table1)

# Close the device
dev.off()


```

# Demographics of dataset following exclusions

##### *Age*

Age has already been limited to age 35-65 

```{r}
ggplot(cc_dat, aes(x = age_A0)) +
  geom_bar(fill = "lightblue", color = "black") +
  labs(
    title = "Spread of Age in middle aged cohort at baseline",
    x = "Age(years)",
    y = "Count"
  ) +
  theme_minimal()
```

##### *Sex*

```{r}
ggplot(cc_dat, aes(x = sex)) +
  geom_bar(fill = "lightblue", color = "black") +
  labs(
    title = "Split of sex in UK Biobank middle aged cohort at baseline",
    x = "Sex",
    y = "Count"
  ) +
  theme_minimal()
 
```

##### *Ethnicity*
Ethnicity has multiple catagoies in UK Biobank, these have been recoded to groupings that are most relevant to bone health.

Ethnicity was recoded to show the following groupings 
 - 1 = White, 
 - 2 = Asian and British Asian,
 - 3 = Black and Black British,
-  4 = Mixed

```{r }
ggplot(cc_dat, aes(x = ethnicity)) +
  geom_bar(fill = "lightblue", color = "black") +
  labs(
    title = "Spread of ethnicity in UK Biobank middle aged cohort at baseline",
    x = "Ethnicity",
    y = "Count"
  ) +
  theme_minimal() 
```


### Exposure variables (PA)

Participants were asked about activities undertaken in the last 4 weeks including frequency, intensity and duration. These are reported as raw values. From these a number of  Metabolic Equivalent Task (MET) minutes of activity were also derived. 

Activity measures (split into moderate, vigorous, walking and summed activity)

- number of days of activity per week
- duration of activity per week
- mins/wk of activity
- MET mins of activity per week


#### Treatment of outliers (already applied to the data by UKB)
- For individual catagories of walking, moderate and vig activity exercise was capped at a maximum of 180 minutes a day, allowing a maximum of 21 hours a week (3 hours*7) 
- Extreme outliers where the sum of walking, moderate and vigorous time variables exceeds 960 minutes (16 hours a day) the whole record is excluded from the analysis as unlikely. 

#### Missing data
We are using only participants with all of duration and number of days/wk of activity in our main analysis. Those with missing values in either column are considered NA in the MET calculations and mins/wk calculations. This differs to the UKB anaysis where some data is imputed if just duration is missing. We will use this for comparison in the sensitivity analysis.

#### Unable to walk
- For those who respond that they were unable to walk instead of removing them they are given a value of 0 under time spent walking.

#### Derivation and cutpoints

The full IPAQ calculates total physical activity as a combination of both leisure time PA (LTPA) as well as domains of work and normal activity - as such the resulting median MET-minutes is higher than for participation in LTPA alone. The general public health recommendations of 30 mins of MVPA are relatively low with most adults being able to achieve this regardless of leisure time activity. To look at the health benefits of LTPA higher cut point thresholds are needed for UKB IPAQ data.

#### Summed days activity per week 

Sum of days performing walking, moderate and vigorous activity - question derived from answers to number of days doing each of the following in a week so total of all will add up to more than 7 but cant be over 21.

- Summed MET minutes per week for all activity 

As with the above this is the total amount of time in minutes spent walking, doing vigorous and doing moderate PA. Unlike summed days this should not exceed the total number of minutes in a week



```{r}
hist(cc_dat$MET_mod, 
     main = "Histogram of MET mins/week vigorous activity", 
     xlab = "MET mins/week of vigorous activity", 
     ylab = "Frequency", 
     col = "lightblue", 
     border = "black")
```

```{r}
hist(cc_dat$MET_MVPA, 
     main = "Histogram of MET mins/week Moderate and vigorous (MVPA) activity", 
     xlab = "MET mins/week of MVPA", 
     ylab = "Frequency", 
     col = "lightblue", 
     border = "black")
```

```{r}

hist(cc_dat$MET_walk, 
     main = "Histogram of MET mins/week of walking", 
     xlab = "MET mins/week of all activity", 
     ylab = "Frequency", 
     col = "lightblue", 
     border = "black")

```

```{r}

hist(cc_dat$summed_MET_all, 
     main = "Histogram of summed MET mins/week for all activity", 
     xlab = "MET mins/week of all activity", 
     ylab = "Frequency", 
     col = "lightblue", 
     border = "black")

```


```{r}
vars <- c("MET_mod", "MET_vig", "MET_MVPA","MET_walk", "summed_MET_all")

PA_summary_sex <- cc_dat %>%
  group_by(sex) %>%
  summarise(
    across(
      all_of(vars),
      list(
        N        = ~ sum(!is.na(.)),
        Mean     = ~ round(mean(., na.rm = TRUE),2),
        SD       = ~ round(sd(., na.rm = TRUE),2),
        Median   = ~ round(median(., na.rm = TRUE),2),
        Min      = ~ min(., na.rm = TRUE),
        Max      = ~ max(., na.rm = TRUE),
        IQR_low  = ~ quantile(., 0.25, na.rm = TRUE),
        IQR_high = ~ quantile(., 0.75, na.rm = TRUE)
      ),
      .names = "{.col}_{.fn}"
    )
  ) 
PA_summary_total <- cc_dat %>%
  summarise(
    across(
      all_of(vars),
      list(
        N        = ~ sum(!is.na(.)),
        Mean     = ~ round(mean(., na.rm = TRUE),2),
        SD       = ~ round(sd(., na.rm = TRUE),2),
        Median   = ~ round(median(., na.rm = TRUE),2),
        Min      = ~ min(., na.rm = TRUE),
        Max      = ~ max(., na.rm = TRUE),
        IQR_low  = ~ quantile(., 0.25, na.rm = TRUE),
        IQR_high = ~ quantile(., 0.75, na.rm = TRUE)
      ),
      .names = "{.col}_{.fn}"
    )
  ) %>%
  mutate(sex = "Total") %>%
  select(sex, everything())  # make sex the first column for consistency

PA_summary <- bind_rows(PA_summary_sex, PA_summary_total) %>%
  pivot_longer(
    -sex,
    names_to = c("Variable", ".value"),
    names_pattern = "^(.*)_(N|Mean|SD|Median|Min|Max|IQR_low|IQR_high)$"
  )

save_table_word(
  df = PA_summary,  # your data frame
  table_number = "Table 3.1",  # can be numeric or string
  folder_path = TABLES_DIR,       # uses setup-defined folder
  title = "Summary statistics on Met mins/wk of activity at baseline"
)


```

#### International Physical Activity Questionnaire (IPAQ) 
Based on activity frequency, duration and intensity an activity group is derived as being low, moderate or high active.


```{r }
ggplot(cc_dat, aes(x = IPAQ)) +
  geom_bar(fill = "lightblue", color = "black") +
  labs(
    title = "Derived IPAQ activity group",
    x = "IPAQ group",
    y = "Count"
  ) +
  theme_minimal() 

```


### Physical activity status by outcome

```{r}
PA_vars <- c("MET_mod", "MET_vig", "MET_MVPA", "summed_MET_all")

cc_dat <- cc_dat %>%
  mutate(
    Fracture = factor(SRF, levels = c(0, 1), labels = c("No fracture", "Fracture"))
  )

# Summarise by fracture
PA_summary_fracture <- cc_dat %>%
  group_by(SRF) %>%
  summarise(
    across(
      all_of(PA_vars),
      list(
        N        = ~ sum(!is.na(.)),
        Mean     = ~ round(mean(., na.rm = TRUE), 2),
        SD       = ~ round(sd(., na.rm = TRUE), 2),
        Median   = ~ round(median(., na.rm = TRUE), 2),
        Min      = ~ min(., na.rm = TRUE),
        Max      = ~ max(., na.rm = TRUE),
        IQR_low  = ~ quantile(., 0.25, na.rm = TRUE),
        IQR_high = ~ quantile(., 0.75, na.rm = TRUE)
      ),
      .names = "{.col}_{.fn}"
    )
  )

# Summarise total (all participants)
PA_summary_total <- cc_dat %>%
  summarise(
    across(
      all_of(PA_vars),
      list(
        N        = ~ sum(!is.na(.)),
        Mean     = ~ round(mean(., na.rm = TRUE), 2),
        SD       = ~ round(sd(., na.rm = TRUE), 2),
        Median   = ~ round(median(., na.rm = TRUE), 2),
        Min      = ~ min(., na.rm = TRUE),
        Max      = ~ max(., na.rm = TRUE),
        IQR_low  = ~ quantile(., 0.25, na.rm = TRUE),
        IQR_high = ~ quantile(., 0.75, na.rm = TRUE)
      ),
      .names = "{.col}_{.fn}"
    )
  ) %>%
  mutate(fracture = "Total") %>%
  select(fracture, everything())

PA_summary <- bind_rows(PA_summary_fracture, PA_summary_total) %>%
  pivot_longer(
    -SRF,
    names_to = c("Variable", ".value"),
    names_pattern = "^(.*)_(N|Mean|SD|Median|Min|Max|IQR_low|IQR_high)$"
  ) %>%
  rename(`Fracture status` = SRF)


save_table_word(
  df = PA_summary,  # your data frame
  table_number = "Table 3.2",  # can be numeric or string
  folder_path = TABLES_DIR,       # uses setup-defined folder
  title = "Summary statistics on Met mins/wk of activity at baseline by fracture status"
)

```

### Relationship between moderate and vigorous PA

```{r}
ggplot(cc_dat, aes(MET_mod, MET_vig)) + geom_point()
```


### Log transformations to correct for extreme skew ###

All activity data is skewed, look at whether log transformation helps normalise the data

```{r}
# Function to log transform variables and plot

log_transform_plot <- function(data, vars, add_one = TRUE, bins = 50) {
  transformed_data <- data
  
  plots <- list()
  
  for (var in vars) {
    # New variable name
    log_var <- paste0("log_", var)
    
    # Log transform
    if (add_one) {
      transformed_data <- transformed_data %>%
        mutate(!!log_var := log(!!rlang::sym(var) + 1))
    } else {
      transformed_data <- transformed_data %>%
        mutate(!!log_var := log(!!rlang::sym(var)))
    }
    
    # Create histogram plot
    p <- ggplot(transformed_data, aes(x = !!rlang::sym(log_var))) +
      geom_histogram(bins = bins, fill = "steelblue", color = "white") +
      theme_minimal() +
      labs(
        x = log_var,
        y = "Count",
        title = paste("Histogram of", log_var)
      )
    
    plots[[log_var]] <- p
  }
  
  return(list(
    data = transformed_data,
    plots = plots
  ))
}

```

```{r}

result <- log_transform_plot(cc_dat, vars = c("MET_mod", "MET_vig", "MET_MVPA", "MET_walk", "summed_MET_all"))

# Access the transformed data
cc_dat_transformed <- result$data

# Display the plots
result$plots$log_MET_mod
result$plots$log_MET_vig
result$plots$log_MET_MVPA
result$plots$log_MET_walk
result$plots$log_summed_MET_all

```

#### examine for variation at extremes of activity


#### For all variables - need to consider the split of PA

````{r}

create_quintile_bins <- function(data, vars) {
  binned_data <- data
  
  for (var in vars) {
    bin_var <- paste0(var, "_q")  # _q for quintile
    
    # 1️⃣ Calculate breaks and make unique
    breaks <- unique(quantile(binned_data[[var]], probs = seq(0, 1, 0.2), na.rm = TRUE))
    
    # 2️⃣ Only cut if there is more than one unique break
    if (length(breaks) > 1) {
      binned_data[[bin_var]] <- cut(
        binned_data[[var]],
        breaks = breaks,
        include.lowest = TRUE,
        labels = paste0("Q", seq_len(length(breaks) - 1))
      )
    } else {
      # If all values are the same, put in single bin
      binned_data[[bin_var]] <- factor("Q1", levels = "Q1")
    }
  }
  
  return(binned_data)
}

PA_vars <- c("MET_mod", "MET_vig", "MET_walk", "MET_MVPA", "summed_MET_all")

cc_dat <- create_quintile_bins(cc_dat, PA_vars)

# Check new columns
head(cc_dat[, c(PA_vars, paste0(PA_vars, "_q"))])



PA_quintile_summary <- lapply(PA_vars, function(var) {
  bin_var <- paste0(var, "_q")
  cc_dat %>%
    group_by(.data[[bin_var]]) %>%
    summarise(
      N = n(),
      Fractures = sum(SRF == "Yes", na.rm = TRUE),
      `Fracture %` = round(100 * mean(SRF == "Yes", na.rm = TRUE), 2)
    ) %>%
    mutate(PA_variable = var) %>%
    rename(Bin = .data[[bin_var]])
}) %>%
  bind_rows() %>%
  select(PA_variable, Bin, N, Fractures, `Fracture %`) %>%
  arrange(PA_variable, Bin)

PA_quintile_summary

for (var in PA_vars) {
  bin_var <- paste0(var, "_q")
  
  p <- ggplot(cc_dat, aes(x = .data[[bin_var]], y = as.numeric(SRF == "Yes"))) +
    geom_bar(stat = "summary", fun = "mean", fill = "steelblue", alpha = 0.7) +
    ylab("Proportion with fracture") +
    xlab(paste0(var, " (quintiles)")) +
    ggtitle(paste0("Fracture proportion by ", var, " quintiles")) +
    theme_minimal() +
    ylim(0, 1)
  
  print(p)
}


````
#### Extreme behaviour

```{r}
PA_vars <- c("MET_mod", "MET_vig", "MET_walk", "MET_MVPA")

for (var in PA_vars) {
  extreme_var <- paste0(var, "_extreme")
  
  # 1️⃣ Compute 10th and 90th percentiles
  p10 <- quantile(cc_dat[[var]], 0.10, na.rm = TRUE)
  p90 <- quantile(cc_dat[[var]], 0.90, na.rm = TRUE)
  
  # 2️⃣ Make sure breaks are strictly increasing
  breaks <- unique(c(-Inf, p10, p90, Inf))
  
  # 3️⃣ Only cut if we have enough unique breaks
  if (length(breaks) == 4) {  # -Inf, p10, p90, Inf
    cc_dat[[extreme_var]] <- cut(
      cc_dat[[var]],
      breaks = breaks,
      labels = c("Bottom 10%", "Middle 80%", "Top 10%"),
      right = TRUE
    )
  } else {
    # Fallback: if too few unique values, put everything in Middle
    cc_dat[[extreme_var]] <- factor("Middle 80%", levels = c("Bottom 10%", "Middle 80%", "Top 10%"))
  }
}


# 2️⃣ Summarize fractures per extreme bin
PA_extreme_summary <- lapply(PA_vars, function(var) {
  extreme_var <- paste0(var, "_extreme")
  
  cc_dat %>%
    group_by(.data[[extreme_var]]) %>%
    summarise(
      N = n(),
      Fractures = sum(SRF == "Yes", na.rm = TRUE),
      `Fracture %` = round(100 * mean(SRF == "Yes", na.rm = TRUE), 2)
    ) %>%
    mutate(PA_variable = var) %>%
    rename(Bin = .data[[extreme_var]])
}) %>%
  bind_rows() %>%
  arrange(PA_variable, Bin)

PA_extreme_summary

for (var in PA_vars) {
  extreme_var <- paste0(var, "_extreme")
  
  p <- ggplot(cc_dat, aes(x = .data[[extreme_var]], y = as.numeric(SRF == "Yes"))) +
    geom_bar(stat = "summary", fun = "mean", fill = "steelblue", alpha = 0.7) +
    ylab("Proportion with fracture") +
    xlab(paste0(var, " (minutes/week)")) +
    ggtitle(paste0("Fracture proportion by ", var, " extremes")) +
    theme_minimal() +
    ylim(0, 1)
  
  print(p)
}
```

#### Examined by 10 year age group
```{r}
PA_vars <- c("MET_mod", "MET_vig", "MET_walk", "MET_MVPA")

# Loop through variables
PA_extreme_summary_age <- lapply(PA_vars, function(var) {
  extreme_var <- paste0(var, "_extreme")
  
  cc_dat %>%
    group_by(agegp_A0, .data[[extreme_var]]) %>%
    summarise(
      N = n(),
      Fractures = sum(SRF == "Yes", na.rm = TRUE),
      `Fracture %` = round(100 * mean(SRF == "Yes", na.rm = TRUE), 2)
    ) %>%
    mutate(PA_variable = var) %>%
    rename(Bin = .data[[extreme_var]])
}) %>%
  bind_rows() %>%
  arrange(PA_variable, agegp_A0, Bin)

PA_extreme_summary_age

for (var in PA_vars) {
  extreme_var <- paste0(var, "_extreme")
  
  p <- ggplot(cc_dat, aes(x = .data[[extreme_var]], y = as.numeric(SRF == "Yes"))) +
    geom_bar(stat = "summary", fun = "mean", fill = "steelblue", alpha = 0.7) +
    facet_wrap(~agegp_A0) +  # stratify by age group
    ylab("Proportion with fracture") +
    xlab(paste0(var, " (minutes/week)")) +
    ggtitle(paste0("Fracture proportion by ", var, " extremes and age group")) +
    theme_minimal() +
    ylim(0, 1)
  
  print(p)
}

```
 #### age and sex
 
```{r}
PA_vars <- c("MET_mod", "MET_vig", "MET_walk", "MET_MVPA")

PA_extreme_summary_age_sex <- lapply(PA_vars, function(var) {
  extreme_var <- paste0(var, "_extreme")
  
  cc_dat %>%
    group_by(agegp_A0, sex, .data[[extreme_var]]) %>%
    summarise(
      N = n(),
      Fractures = sum(SRF == "Yes", na.rm = TRUE),
      `Fracture %` = round(100 * mean(SRF == "Yes", na.rm = TRUE), 2)
    ) %>%
    mutate(PA_variable = var) %>%
    rename(Bin = .data[[extreme_var]])
}) %>%
  bind_rows() %>%
  arrange(PA_variable, agegp_A0, sex, Bin)

PA_extreme_summary_age_sex

for (var in PA_vars) {
  extreme_var <- paste0(var, "_extreme")
  
  p <- ggplot(cc_dat, aes(x = .data[[extreme_var]], y = as.numeric(SRF == "Yes"))) +
    geom_bar(stat = "summary", fun = "mean", fill = "steelblue", alpha = 0.7) +
    facet_grid(agegp_A0 ~ sex) +  # stratify by age group (rows) and sex (columns)
    ylab("Proportion with fracture") +
    xlab(paste0(var, " (minutes/week)")) +
    ggtitle(paste0("Fracture proportion by ", var, " extremes, age group & sex")) +
    theme_minimal() +
    ylim(0, 1)
  
  print(p)
}
```
 
 


```{r}
# For use in TTE descriptive
# 
# ggplot(cc_dat[!is.na(cc_dat$mins_wk_mod), ], aes(x = mins_wk_mod)) +
#   geom_histogram(binwidth = 5, fill = "skyblue", color = "black") +
#   labs(title = "Histogram of minutes/week of moderate activity",
#        x = "Duration (minutes/wk)",
#        y = "Count") +
#   theme_minimal()
```


# ```{r}
# ggplot(dat[!is.na(dat$mins_wk_vig), ], aes(x = mins_wk_vig)) +
#   geom_histogram(binwidth = 5, fill = "skyblue", color = "black") +
#   labs(title = "Histogram of minutes/week of vigorous activity",
#        x = "Duration  (minutes/wk)",
#        y = "Count") +
#   theme_minimal()
# ```




# ```{r}
# ggplot(dat[!is.na(dat$mins_wk_walk), ], aes(x = mins_wk_walk)) +
#   geom_histogram(binwidth = 5, fill = "skyblue", color = "black") +
#   labs(title = "Histogram of mins/week walking",
#        x = "Duration Walk (minutes/wk)",
#        y = "Count") +
#   theme_minimal()
# ```

# ```{r}
# hist(dat$MET_walk, 
#      main = "Histogram of MET mins/week walking activity", 
#      xlab = "MET mins/week of wallking activity", 
#      ylab = "Frequency", 
#      col = "lightblue", 
#      border = "black")
# ```

# ```{r}
# vars <- c("mins_wk_walk", "MET_walk")
# 
# PA_summary_sex <- dat %>%
#   group_by(sex) %>%
#   summarise(
#     across(
#       all_of(vars),
#       list(
#         N        = ~ sum(!is.na(.)),
#         Mean     = ~ round(mean(., na.rm = TRUE),2),
#         SD       = ~ round(sd(., na.rm = TRUE),2),
#         Median   = ~ round(median(., na.rm = TRUE),2),
#         Min      = ~ min(., na.rm = TRUE),
#         Max      = ~ max(., na.rm = TRUE),
#         IQR_low  = ~ quantile(., 0.25, na.rm = TRUE),
#         IQR_high = ~ quantile(., 0.75, na.rm = TRUE)
#       ),
#       .names = "{.col}_{.fn}"
#     )
#   ) 
# PA_summary_total <- dat %>%
#   summarise(
#     across(
#       all_of(vars),
#       list(
#         N        = ~ sum(!is.na(.)),
#         Mean     = ~ round(mean(., na.rm = TRUE),2),
#         SD       = ~ round(sd(., na.rm = TRUE),2),
#         Median   = ~ round(median(., na.rm = TRUE),2),
#         Min      = ~ min(., na.rm = TRUE),
#         Max      = ~ max(., na.rm = TRUE),
#         IQR_low  = ~ quantile(., 0.25, na.rm = TRUE),
#         IQR_high = ~ quantile(., 0.75, na.rm = TRUE)
#       ),
#       .names = "{.col}_{.fn}"
#     )
#   ) %>%
#   mutate(sex = "Total") %>%
#   select(sex, everything())  # make sex the first column for consistency
# 
# PA_summary <- bind_rows(PA_summary_sex, PA_summary_total) %>%
#   pivot_longer(
#     -sex,
#     names_to = c("Variable", ".value"),
#     names_pattern = "^(.*)_(N|Mean|SD|Median|Min|Max|IQR_low|IQR_high)$"
#   )
# 
# 
# Table_3.3 <-make_table(
#   PA_summary,
#   table_number = "3.3",
#   folder_path = Table_folder_path,
#   title = "Summary statistics on walking activity at baseline"
# )

# Table_3.3
# ```


